# BillInsight

## Test data

-   CT: OV203555509416602
-   InvoiceCode: BF394B7E06

## Build Steps

-   Call API l·∫•y prefix
-   Call API l·∫•y captcha
-   nh·∫≠p m√£ CT, captchae v√† m√£ truy xu·∫•t h√≥a ƒë∆°n
-   call api
-   l·∫•y d·ªØ li·ªáu

    -   t·∫£i xml v√† truy xu·∫•t d·ªØ li·ªáu
    -   ƒë·ªçc t·ª´ file pdf

-   g·ªçi api ch·ªânh s·ª≠a sheet
-   l∆∞u ·∫£nh v√†o cloudinary

## Setup

### Setup d·ª± √°n google cloud console

#### Create new project

-   T·∫°o Project
-   B·∫≠t API

    -   V√†o APIs & Services ‚Üí Library.
    -   B·∫≠t Google Sheets API (v√† Google Drive API n·∫øu c·∫ßn).

#### AUth

-   C√°ch 1: UserCredential (OAuth 2.0 cho user login)

    -   V√†o APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth Client ID.
    -   Ch·ªçn Application type = Desktop app.
    -   T·∫£i file **credentials.json** v·ªÅ.

-   C√°ch 2:(B) GoogleCredential (Service Account ‚Äì kh√¥ng c·∫ßn user login)

    -   V√†o APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí Service Account.
    -   T·∫°o service account, ƒë·∫∑t t√™n.
    -   Download file **service_account.json**.
    -   L·∫•y email c·ªßa service account (d·∫°ng **xxx@project-id.iam.gserviceaccount.com**).
    -   Chia s·∫ª Google Sheet cho email n√†y v·ªõi quy·ªÅn Editor.

### Code C# ƒë·ªÉ s·ª≠ d·ª•ng Google Sheets API

-   T·∫£i th∆∞ vi·ªán

    ```bash
    Install-Package Google.Apis.Sheets.v4
    Install-Package Google.Apis.Drive.v3
    Install-Package Google.Apis.Auth
    ```

#### GoogleCredential

-   S·ª≠ d·ª•ng v·ªõi GoogleCredential

    ```csharp

    using Google.Apis.Auth.OAuth2;
    using Google.Apis.Services;
    using Google.Apis.Sheets.v4;
    using Google.Apis.Sheets.v4.Data;
    using Google.Apis.Util.Store;
    using System.IO;
    using System.Threading;

    GoogleCredential credential;
    using (var stream = new FileStream("/home/newtun/Desktop/TestAPI/TestAPI/secrets/billinsight-0b2c14cec552.json", FileMode.Open, FileAccess.Read))
    {
        credential = GoogleCredential.FromStream(stream)
        .CreateScoped(SheetsService.Scope.Spreadsheets);
    }

    var service = new SheetsService(new BaseClientService.Initializer()
    {
        HttpClientInitializer = credential,
        ApplicationName = "BillInsight",
    });

    // - ƒê·ªçc d·ªØ li·ªáu
    const string spreadsheetId = "1D4UeZBozLOjiIlhJ-YSuok-MqIJDCYicoI807K0tj1o";
    String range = "Sheet1!A1";

    var request = service.Spreadsheets.Values.Get(spreadsheetId, range);
    var response = request.Execute();

    var values = response.Values;
    if (values != null && values.Count > 0)
    {
        foreach (var row in values)
        Console.WriteLine(string.Join(" | ", row));
    }
    ```

    -   Kh√¥ng c√≥ popup login.
    -   Ch·ªâ ch·∫°y ƒë∆∞·ª£c n·∫øu Google Sheet ƒë∆∞·ª£c share cho service account email.
    -   Th√≠ch h·ª£p khi app ch·ªâ d√πng cho 1 t√†i kho·∫£n h·ªá th·ªëng c·ªë ƒë·ªãnh (v√≠ d·ª• server app, automation).

#### UserCredential

-   S·ª≠ d·ª•ng v·ªõi UserCredential

    ```csharp
    using Google.Apis.Auth.OAuth2;
    using Google.Apis.Services;
    using Google.Apis.Sheets.v4;
    using Google.Apis.Sheets.v4.Data;
    using Google.Apis.Util.Store;
    using System.IO;
    using System.Threading;

    class Program
    {
    static string[] Scopes = { SheetsService.Scope.Spreadsheets };
    static string ApplicationName = "Google Sheets API C# Demo";

        static void Main(string[] args)
        {
            UserCredential credential;
            using (var stream = new FileStream("credentials.json", FileMode.Open, FileAccess.Read))
            {
                string credPath = "token.json";
                credential = GoogleWebAuthorizationBroker.AuthorizeAsync(
                    GoogleClientSecrets.FromStream(stream).Secrets,
                    Scopes,
                    "user",
                    CancellationToken.None,
                    new FileDataStore(credPath, true)).Result;
            }

            var service = new SheetsService(new BaseClientService.Initializer()
            {
                HttpClientInitializer = credential,
                ApplicationName = ApplicationName,
            });

            string spreadsheetId = "YOUR_SHEET_ID";
            string range = "Sheet1!A1:D5";
            var request = service.Spreadsheets.Values.Get(spreadsheetId, range);
            var response = request.Execute();

            foreach (var row in response.Values)
                System.Console.WriteLine(string.Join(" | ", row));
        }

    }
    ```

-   L·∫ßn ƒë·∫ßu ch·∫°y s·∫Ω m·ªü tr√¨nh duy·ªát ‚Üí user ƒëƒÉng nh·∫≠p Google ‚Üí c·∫•p quy·ªÅn.
-   Token l∆∞u ·ªü token.json, l·∫ßn sau kh√¥ng c·∫ßn login l·∫°i.
-   Th√≠ch h·ª£p khi app c·∫ßn cho nhi·ªÅu ng∆∞·ªùi d√πng kh√°c nhau ch·∫°y v·ªõi t√†i kho·∫£n ri√™ng c·ªßa h·ªç
-   N·∫øu trong m√¥i tr∆∞·ªùng ph√°t tri·ªÉn, m·∫∑c ƒë·ªãnh ·ª©ng d·ª•ng Unverified app, th√¨ email ƒëƒÉng nh·∫°p c·∫ßn n·∫±m trong danh s√°ch Test users c·ªßa ·ª©ng d·ª•ng m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng app

-   C√°ch kh·∫Øc ph·ª•c nhanh (cho ph√°t tri·ªÉn / testing)
    V√†o Google Cloud Console ‚Üí APIs & Services ‚Üí OAuth consent screen.
    ·ªû b∆∞·ªõc User type, b·∫°n ch·ªçn External (n·∫øu mu·ªën cho account ngo√†i t·ªï ch·ª©c G-Suite).
    Trong ph·∫ßn Test users, th√™m email abc@gmail.com c·ªßa b·∫°n (v√† c√°c email tester kh√°c n·∫øu c·∫ßn).
    üëâ Sau ƒë√≥ b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p m√† kh√¥ng b·ªã l·ªói.

-   N·∫øu mu·ªën kh·∫Øc ph·ª•c l√¢u d√†i (cho tri·ªÉn khai ch√≠nh th·ª©c) c·∫ßn verify app

### So s√°nh UserCredential vs GoogleCredential

-   Ti√™u ch√≠ UserCredential (OAuth2) GoogleCredential (Service Account)
-   ƒêƒÉng nh·∫≠p Ng∆∞·ªùi d√πng ph·∫£i login Google (m·ªôt l·∫ßn, token ƒë∆∞·ª£c l∆∞u l·∫°i) Kh√¥ng c·∫ßn login, ch·∫°y t·ª± ƒë·ªông
-   ƒê·ªëi t∆∞·ª£ng s·ª≠ d·ª•ng ·ª®ng d·ª•ng client d√†nh cho nhi·ªÅu ng∆∞·ªùi d√πng ·ª®ng d·ª•ng server/automation, 1 t√†i kho·∫£n c·ªë ƒë·ªãnh
-   Quy·ªÅn truy c·∫≠p D·ª±a tr√™n t√†i kho·∫£n Google user ƒëƒÉng nh·∫≠p D·ª±a tr√™n email c·ªßa service account (ph·∫£i share t√†i li·ªáu)
-   Tri·ªÉn khai D·ªÖ d√πng cho end-user (m·ªói ng∆∞·ªùi d√πng login b·∫±ng account c·ªßa h·ªç) D·ªÖ d√πng cho backend/system app (kh√¥ng ai ph·∫£i login)
-   File credentials credentials.json (OAuth client ID) **service_account.json** (private key + email service)

### features

-   Settings
-   Themes
-   Nh·∫≠p keys

    -   nh·∫≠p file **service_account.json**
    -   nh·∫≠p ID c·ªßa spreadsheet
    -   Key cloudinary
    -   Key supabase

-   L∆∞u ·∫£nh
-   Xem t·ªïng s·ªë ti·ªÅn, s·ªë ti·ªÅn ƒë√£ d√πng, s·ªë ti·ªÅn c√≤n l·∫°i
-   xem danh s√°ch ·∫£nh h√≥a ƒë∆°n, theo ng√†y
-   Xem chi ti·∫øt h√≥a ƒë∆°n
-   Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c sheet
-   Template sheet

#### C√°c b∆∞·ªõc th√™m h√≥a ƒë∆°n

-   T·∫£i file ·∫£nh
-   Get GetPrefixAndSvID
-   GetCaptchaAndASPSession
-   nh·∫≠p m√£ ƒë∆°n, m√£ h√≥a ƒë∆°n, captcha
-   SendAPI
-   Xem tr∆∞·ªõc d·ªØ li·ªáu, ƒë∆∞·ª£c quy·ªÅn ch·ªânh s·ª≠a, t·ªïng ti·ªÅn
-   Ch·ªçn ng√†y h√≥a ƒë∆°n
-   C·∫≠p nh·∫≠t spreadsheet v√† l∆∞u ·∫£nh h√≥a ƒë∆°n t·∫°i cloudinary
-   c√≥ th·ªÉ nh·∫≠p d·ªØ li·ªáu b·∫±ng tay
-   Lo·∫°i ti·ªÅn m·∫∑t ho·∫∑c ng√¢n h√†ng
-   tri·ªÉn khai cho nhi·ªÅu lo·∫°i h√≥a ƒë∆°n kh√°c

#### Backend

-   L∆∞u data d∆∞·ªõi d·∫°ng json
-   ·ª®ng d·ª•ng ƒë∆∞·ª£c c√†i ƒë·∫∑t trong app data
-   Android, Windows, Linux
-   ·∫¢nh l∆∞u t·∫°i clouidinary
-   Key l∆∞u t·∫°i local
-   Attachment l∆∞u t·∫°i supabase

#### m√†ng h√¨nh

-   Th·ªëng k√™: theo ng√†y, theo tu·∫ßn, theo th√°ng, t·ªïng chi ti√™u
-   Xem chi ti·∫øt h√≥a ƒë∆°n, xem t·ª´ng sheet
-   Xem danh s√°ch ·∫£nh h√≥a ƒë∆°n
-   Nh·∫≠p h√≥a ƒë∆°n
-   Th√¥ng tin - nh·∫≠p ID c·ªßa spreadsheet, danh s√°ch sheet, thao t√°c v·ªõi sheet
-   Settings
    -   Set theme
    -   Clear all data
    -   Keys
        -   nh·∫≠p file service_account.json
        -   Key cloudinary
        -   Key supabase

